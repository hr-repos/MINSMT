@{
    ViewData["Title"] = "Chess Game";
}

<link rel="stylesheet" href="~/lib/chessboardjs/chessboard-1.0.0.css" />
<link rel="stylesheet" href="~/css/site.css" />

<div class="cc-shell">

    <!-- LEFT: empty sidebar  -->
    <aside class="cc-leftbar">
    <div class="cc-leftbar-title">MINSMT</div>
    </aside>

    <!-- RIGHT: content -->
    <div class="cc-content">
        <div class="cc-page">
            <main class="cc-main">

                <!-- LEFT: board + players -->
                <section class="cc-board-area">

                    <div class="cc-board-wrap">
                        <div class="cc-frame">

                            <!-- TOP BAR -->
                            <div class="cc-boardbar cc-boardbar-top">
                                <div class="cc-player-left">
                                    <span class="cc-avatar" aria-hidden="true">
                                        <svg viewBox="0 0 64 64" role="img" focusable="false">
                                            <circle cx="32" cy="24" r="12"></circle>
                                            <path d="M12 56c2-12 12-20 20-20s18 8 20 20"></path>
                                        </svg>
                                    </span>
                                    <span>Opponent</span>
                                </div>

                                <span class="cc-timer" id="timerTop">10:00</span>
                            </div>

                            
                            <div id="board"></div>

                            <!-- BOTTOM BAR -->
                            <div class="cc-boardbar cc-boardbar-bottom">
                                <div class="cc-player-left">
                                    <span class="cc-avatar" aria-hidden="true">
                                        <svg viewBox="0 0 64 64" role="img" focusable="false">
                                            <circle cx="32" cy="24" r="12"></circle>
                                            <path d="M12 56c2-12 12-20 20-20s18 8 20 20"></path>
                                        </svg>
                                    </span>
                                    <span>Player</span>
                                </div>

                                <span class="cc-timer" id="timerBottom">10:00</span>
                            </div>

                        </div>
                            <div id="gameOverMessage" class="cc-gameover" style="display:none;"></div>
                            <div id="promotionPicker" class="cc-promo" style="display:none;"></div>
                    </div>

                    <div id="gameOverMessage" class="cc-gameover" style="display:none;"></div>

                <div id="startInputPopup" class="cc-gameover cc-startpopup" style="display:none;">
                    <div class="cc-popup-title">Enter Unique Code</div>
                    <input id="startInputValue" class="cc-popup-input" type="text" placeholder="Type something..." 
                    autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
                    <div class="cc-popup-actions">
                        <button id="startInputCancel" class="cc-secondary" type="button">Cancel</button>
                        <button id="startInputOk" class="cc-primary" type="button">OK</button>
                    </div>
                </div>

                <div id="promotionPicker" class="cc-promo" style="display:none;"></div>


                </section>

                <!-- RIGHT: sidebar -->
                <aside class="cc-sidebar">

            <div class="cc-card">
                <button id="startGameBtn" class="cc-primary" type="button">Start Game</button>
                <button id="startBtn" class="cc-primary" type="button" style="display:none;">New Game</button>
                <button id="rematchBtn" class="cc-secondary" type="button" style="display:none;">Rematch</button>
                <button id="resignBtn" class="cc-danger" type="button" style="display:none;">Resign</button>

                <div class="cc-mode-select">
                    <button class="cc-mode-btn active" data-mode="player" type="button">Player</button>
                    <button class="cc-mode-btn" data-mode="cpu" type="button">CPU</button>
                </div>


                <div class="cc-difficulty-select" style="display:none;">
                    <button class="cc-difficulty-btn active" data-level="beginner" type="button">Beginner</button>
                    <button class="cc-difficulty-btn" data-level="intermediate" type="button">Intermediate</button>
                    <button class="cc-difficulty-btn" data-level="expert" type="button">Expert</button>
                    <button class="cc-difficulty-btn" data-level="master" type="button">Master</button>
                </div>
                <div class="cc-side-select" style="display:none;">
                        <button class="cc-side-btn active" data-side="white">White</button>
                        <button class="cc-side-btn" data-side="black">Black</button>
                    </div>


                            <!-- Time selector -->
                        <div class="cc-time-select">
                            <button class="cc-time-btn active" data-time="10">10 min</button>
                            <button class="cc-time-btn" data-time="20">20 min</button>
                            <button class="cc-time-btn" data-time="30">30 min</button>
                        </div>
                    </div>
                <div class="cc-card cc-connection-card">
                    <div id="connectionStatus" class="cc-connection disconnected">
                        Disconnected
                    </div>
                </div>

                </aside>

            </main>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="~/lib/chessboardjs/chessboard-1.0.0.js"></script>

<script>
    let selectedTime = 10;
    let selectedMode = "player";
    let selectedDifficulty = "beginner";
    let selectedSide = "white";

    function updateDifficultyVisibility() {
        const $el = $('.cc-difficulty-select').stop(true, true);

        if (selectedMode === "cpu") {
            $el.show();
        } else {
            $el.hide();
        }
    }

    function updateSideVisibility() {
        const $el = $('.cc-side-select').stop(true, true);

        if (selectedMode === "cpu") {
            $el.show();
        } else {
            $el.hide();
        }
    }

    function updateTimerVisibility() {
        const cpu = (selectedMode === "cpu");

        $('.cc-shell').toggleClass('cc-mode-cpu', cpu);
    }

    $('.cc-time-btn').on('click', function () {
        if ($(this).hasClass('disabled')) return;

        $('.cc-time-btn').removeClass('active');
        $(this).addClass('active');

        selectedTime = $(this).data('time');
        console.log("Selected time:", selectedTime);

        if (typeof matchActive !== "undefined" && !matchActive) {
            initClocks(selectedTime);
        }
    });


    $('.cc-mode-btn').on('click', function () {
        if ($(this).hasClass('disabled')) return;

        $('.cc-mode-btn').removeClass('active');
        $(this).addClass('active');

        selectedMode = $(this).data('mode');

        updateDifficultyVisibility();
        updateSideVisibility();
        updateTimerVisibility();

        console.log("Selected mode:", selectedMode);
    });

    $('.cc-difficulty-btn').on('click', function () {
        if ($(this).hasClass('disabled')) return;

        $('.cc-difficulty-btn').removeClass('active');
        $(this).addClass('active');

        selectedDifficulty = $(this).data('level');
        console.log("Selected difficulty:", selectedDifficulty);
    });

    $('.cc-side-btn').on('click', function () {
        if ($(this).hasClass('disabled')) return;

        $('.cc-side-btn').removeClass('active');
        $(this).addClass('active');

        selectedSide = $(this).data('side');
        console.log("Selected side:", selectedSide);

        if (typeof applySideThemes === "function") {
            applySideThemes();
        }

        if (typeof createBoard === "function") {
            var fen = (typeof lastFen !== "undefined" && lastFen) ? lastFen : '@ViewBag.FEN';
            createBoard(false, fen, selectedSide);
        }
    });


    updateDifficultyVisibility();
    updateSideVisibility();
    updateTimerVisibility();
</script>



<script>
    var board = null;
    var lastFen = null;
    var pendingPromotion = null;

    var hasPlayedOnce = false;
    var matchActive = false;

    var clockPlayerSec = 0;
    var clockOpponentSec = 0;
    var clockRunning = false;
    var activeColor = null;
    var lastTickMs = 0;
    var clockIntervalId = null;

    function getPlayerColor() {
        return (selectedSide === "black") ? "b" : "w";
    }

    function formatClock(sec) {
        sec = Math.max(0, Math.floor(sec));
        var m = Math.floor(sec / 60);
        var s = sec % 60;
        return String(m).padStart(2, "0") + ":" + String(s).padStart(2, "0");
    }

    function renderClocks() {
        $("#timerBottom").text(formatClock(clockPlayerSec));
        $("#timerTop").text(formatClock(clockOpponentSec));
    }

    function getFenActiveColor(fen) {
        if (!fen) return null;
        var parts = fen.split(" ");
        if (parts.length < 2) return null;
        return parts[1] === "b" ? "b" : "w";
    }

    function stopClock() {
        clockRunning = false;
        activeColor = null;
        if (clockIntervalId) {
            clearInterval(clockIntervalId);
            clockIntervalId = null;
        }
    }

    function initClocks(minutes) {
        stopClock();
        clockPlayerSec = minutes * 60;
        clockOpponentSec = minutes * 60;
        renderClocks();
    }

    function startClockFromFen(fen) {
        if (selectedMode !== "player") return;
        if (!matchActive) return;

        activeColor = getFenActiveColor(fen);
        lastTickMs = Date.now();

        if (!clockIntervalId) {
            clockIntervalId = setInterval(tickClock, 200);
        }
        clockRunning = true;
    }

    function tickClock() {
        if (!clockRunning || selectedMode !== "player") return;
        if (!matchActive) return;
        if (!activeColor) return;

        var now = Date.now();
        var elapsed = (now - lastTickMs) / 1000.0;
        lastTickMs = now;

        var winnerColor = (activeColor === "w") ? "Black" : "White";

        var playerColor = getPlayerColor();
        var playerColorName = (playerColor === "w") ? "White" : "Black";

        if (activeColor === playerColor) {
            clockPlayerSec -= elapsed;
            if (clockPlayerSec <= 0) {
                clockPlayerSec = 0;
                renderClocks();
                matchActive = false;
                stopClock();

                showGameOver(
                    "Time out! Winner: " + winnerColor,
                    "timeout",
                    winnerColor.toLowerCase()
                );
                return;
            }
        } else {
            clockOpponentSec -= elapsed;
            if (clockOpponentSec <= 0) {
                clockOpponentSec = 0;
                renderClocks();
                matchActive = false;
                stopClock();

                showGameOver(
                    "Time out! Winner: " + winnerColor,
                    "timeout",
                    winnerColor.toLowerCase()
                );
                return;
            }
        }

        renderClocks();
    }



    function applySideThemes() {
        var playerIsWhite = (selectedSide === "white");

        var bottomTheme = playerIsWhite ? "cc-white" : "cc-black";
        var topTheme = playerIsWhite ? "cc-black" : "cc-white";

        $("#timerBottom").removeClass("cc-white cc-black").addClass(bottomTheme);
        $("#timerTop").removeClass("cc-white cc-black").addClass(topTheme);

        $(".cc-boardbar-bottom .cc-avatar").removeClass("cc-white cc-black").addClass(bottomTheme);
        $(".cc-boardbar-top .cc-avatar").removeClass("cc-white cc-black").addClass(topTheme);
    }

    function setDisconnected() {
        $("#connectionStatus")
            .removeClass("connected")
            .addClass("disconnected")
            .text("Disconnected");
    }

    function setConnected(code) {
        $("#connectionStatus")
            .removeClass("disconnected")
            .addClass("connected")
            .text("Connected to " + code);
    }

    function openStartPopup() {
        $("#gameOverMessage").hide();
        $("#promotionPicker").hide();

        $("#startInputValue").val("");
        $("#startInputPopup").fadeIn(120);

        setTimeout(() => $("#startInputValue").trigger("focus"), 150);
    }

    function closeStartPopup() {
        $("#startInputPopup").hide();
    }

    function prepareForNewGame() {
        matchActive = false;
        stopClock();

        applySideThemes();

        $("#gameOverMessage").hide();
        $("#promotionPicker").hide();
        $("#startInputPopup").hide();

        unlockGameSettings();

        $("#startGameBtn").removeClass("disabled").fadeIn(120);
        $("#rematchBtn").hide();

        $("#startBtn").hide();

        $("#resignBtn").hide();

        if ($("#connectionStatus").length) setDisconnected();
    }

    function runStartGameAjax(boardCode) {
        $.ajax({
            url: '/Chess/StartGame',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                mode: selectedMode,
                side: selectedSide,
                difficulty: selectedDifficulty,
                boardCode: boardCode
            }),
            success: function (response) {
                if (!response) return;

                createBoard(true, response.fen, response.orientation);
                lastFen = response.fen;

                $("#gameOverMessage")
                    .hide()
                    .removeClass("win lose draw white black")
                    .text("");

                clearCheckHighlight();

                lockGameSettings();

                $("#startGameBtn").hide();
                $("#startBtn").hide();
                $("#rematchBtn").hide();
                $("#resignBtn").fadeIn(120);

                applyCheckHighlight(response.checkSquare, response.checkAttackers);

                matchActive = true;

                applySideThemes();

                if (selectedMode === "player") {
                    initClocks(selectedTime);
                    startClockFromFen(response.fen);
                } else {
                    stopClock();
                }
            }
        });
    }

    $(function () {
        $("#resignBtn").hide();
        $("#startInputPopup").hide();
        $("#startGameBtn").show();
        $("#startBtn").hide();
        $("#rematchBtn").hide();

        if ($("#connectionStatus").length) setDisconnected();

        applySideThemes();

        $("#startInputCancel").on("click", function () {
            closeStartPopup();
        });

        $("#startInputOk").on("click", function () {
            var value = ($("#startInputValue").val() || "").trim();
            if (!value) return;

            console.log("Popup input:", value);

            if ($("#connectionStatus").length) setConnected(value);

            closeStartPopup();
            runStartGameAjax(value);
        });

        $("#startInputValue").on("keydown", function (e) {
            if (e.key === "Enter") {
                e.preventDefault();
                $("#startInputOk").click();
            }
        });

        $("#rematchBtn").on("click", function () {
            if ($(this).hasClass("disabled")) return;
            openStartPopup();
        });
    });

    function lockGameSettings() {
        $('.cc-mode-btn, .cc-difficulty-btn, .cc-side-btn, .cc-time-btn').addClass('disabled');
    }

    function unlockGameSettings() {
        $('.cc-mode-btn, .cc-difficulty-btn, .cc-side-btn, .cc-time-btn').removeClass('disabled');
    }

    function clearCheckHighlight() {
        $('#board .cc-check').removeClass('cc-check');
        $('#board .cc-check-attacker').removeClass('cc-check-attacker');
    }

    function applyCheckHighlight(checkSquare, attackers) {
        clearCheckHighlight();

        if (checkSquare) {
            $('#board .square-' + checkSquare).addClass('cc-check');
        }

        if (attackers && attackers.length) {
            for (var i = 0; i < attackers.length; i++) {
                $('#board .square-' + attackers[i]).addClass('cc-check-attacker');
            }
        }
    }

    function createBoard(draggable, fen, orientation) {
        if (board) {
            board.destroy();
        }

        board = Chessboard('board', {
            draggable: draggable,
            position: fen,
            orientation: orientation,
            pieceTheme: '/lib/chessboardjs/img/chesspieces/wikipedia/{piece}.png',
            onDrop: onDrop
        });

        setTimeout(() => board.resize(), 0);
        setTimeout(() => board.resize(), 250);
    }

    function showGameOver(message, type, side) {
        matchActive = false;
        stopClock();

        $("#resignBtn").hide();
        $("#startInputPopup").hide();
        $("#promotionPicker").hide();

        hasPlayedOnce = true;

        if ($("#connectionStatus").length) setDisconnected();

        $("#startBtn").removeClass("disabled").fadeIn(120);

        $("#startGameBtn").hide();

        if (hasPlayedOnce) {
            $("#rematchBtn").fadeIn(120);
        }

        var msg = $("#gameOverMessage");
        msg
            .removeClass("win lose draw white black")
            .addClass(type);

        if (side) {
            msg.addClass(side);
        }

        msg.text(message).fadeIn();

        var fen = (board && typeof board.fen === "function") ? board.fen() : lastFen;
        var ori = (board && typeof board.orientation === "function") ? board.orientation() : "white";
        createBoard(false, fen, ori);
    }

    $(window).on('resize', function () {
        if (board) board.resize();
    });

    function isPromotionMove(piece, target) {
        if (!piece || piece.length < 2) return false;

        var color = piece[0];
        var type = piece[1];
        if (type !== 'P') return false;

        var rank = target[1];
        return (color === 'w' && rank === '8') || (color === 'b' && rank === '1');
    }

    function showPromotionPicker(piece, targetSquare, onPick) {
        var picker = $("#promotionPicker");
        picker.empty();

        var color = piece[0];
        var choices = ["q", "n", "r", "b"];

        for (var i = 0; i < choices.length; i++) {
            (function (c) {
                var imgPiece = color + c.toUpperCase();
                var imgUrl = "/lib/chessboardjs/img/chesspieces/wikipedia/" + imgPiece + ".png";

                var btn = $('<button type="button"></button>');
                btn.append('<img src="' + imgUrl + '" alt="' + imgPiece + '">');
                btn.on("click", function () {
                    picker.hide();
                    onPick(c);
                });

                picker.append(btn);
            })(choices[i]);
        }

        var squareEl = $('#board .square-' + targetSquare);
        var wrap = $(".cc-board-wrap");

        if (squareEl.length === 0 || wrap.length === 0) {
            picker.hide();
            return;
        }

        var wrapOffset = wrap.offset();
        var sqOffset = squareEl.offset();
        var sqSize = squareEl.outerWidth();

        picker.css({ width: sqSize + "px", transform: "none" }).show();

        var wrapW = wrap.innerWidth();
        var wrapH = wrap.innerHeight();
        var pickerW = picker.outerWidth();
        var pickerH = picker.outerHeight();

        var left = (sqOffset.left - wrapOffset.left + sqSize + 6);
        var top = (sqOffset.top - wrapOffset.top);

        if (left + pickerW > wrapW - 6) {
            left = (sqOffset.left - wrapOffset.left - pickerW - 6);
        }
        if (left < 6) left = 6;

        if (top + pickerH > wrapH - 6) {
            top = top - pickerH + sqSize;
        }
        if (top < 6) top = 6;

        picker.css({
            left: left + "px",
            top: top + "px"
        });
    }

    function handleMoveResponse(response, oldPos) {
        if (!response || !response.valid) {
            if (oldPos) board.position(oldPos);
            return;
        }

        if (response.fen) {
            board.position(response.fen);
            lastFen = response.fen;
        }

        applyCheckHighlight(response.checkSquare, response.checkAttackers);

        if (selectedMode === "player" && response.fen) {
            startClockFromFen(response.fen);
        }

        if (response.winner) {
            if (response.winner === "Draw") {
                showGameOver("Draw", "draw");
            } else {
                var winnerSide = ("" + response.winner).toLowerCase();
                showGameOver("Checkmate! Winner: " + response.winner, "win", winnerSide);
            }
        }
    }

    function onDrop(source, target, piece, newPos, oldPos, orientation) {
        $("#promotionPicker").hide();

        if (isPromotionMove(piece, target)) {
            pendingPromotion = { from: source, to: target, oldPos: oldPos };

            showPromotionPicker(piece, target, function (promo) {
                if (!pendingPromotion) {
                    board.position(oldPos);
                    return;
                }

                $.ajax({
                    url: '/Chess/Move',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        from: pendingPromotion.from,
                        to: pendingPromotion.to,
                        promotion: promo
                    }),
                    success: function (response) {
                        handleMoveResponse(response, pendingPromotion.oldPos);
                        pendingPromotion = null;
                    },
                    error: function () {
                        board.position(pendingPromotion.oldPos);
                        pendingPromotion = null;
                    }
                });
            });

            return 'snapback';
        }

        $.ajax({
            url: '/Chess/Move',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ from: source, to: target }),
            success: function (response) {
                handleMoveResponse(response, oldPos);
            },
            error: function () {
                board.position(oldPos);
            }
        });
    }

    $('#startGameBtn').click(function () {
        if ($(this).hasClass('disabled')) return;
        openStartPopup();
    });

    $('#startBtn').click(function () {
        if ($(this).hasClass('disabled')) return;
        prepareForNewGame();
    });

    $('#resignBtn').click(function () {
        matchActive = false;
        stopClock();

        $("#promotionPicker").hide();
        $("#startInputPopup").hide();

        $("#resignBtn").hide();

        $.post('/Chess/Resign', function (response) {
            if (response && response.winner) {
                showGameOver("You resigned! Winner: " + response.winner, "lose");
            } else {
                showGameOver("You resigned!", "lose");
            }
        });
    });

    setInterval(() => {
        if (!board) return;

        $.get('/Chess/State', function (response) {
            if (response && response.fen && response.fen !== lastFen) {
                lastFen = response.fen;
                board.position(response.fen);
                applyCheckHighlight(response.checkSquare, response.checkAttackers);

                if (selectedMode === "player") {
                    startClockFromFen(response.fen);
                }
            } else if (response) {
                applyCheckHighlight(response.checkSquare, response.checkAttackers);
            }
        });
    }, 1000);

    createBoard(false, '@ViewBag.FEN', selectedSide);
</script>

