@{
    ViewData["Title"] = "Chess Game";
}

<link rel="stylesheet" href="~/lib/chessboardjs/chessboard-1.0.0.css" />
<link rel="stylesheet" href="~/css/site.css" />

<div class="cc-shell">

    <!-- LEFT: empty sidebar  -->
    <aside class="cc-leftbar">
    <div class="cc-leftbar-title">MINSMT</div>
    </aside>

    <!-- RIGHT: content -->
    <div class="cc-content">
        <div class="cc-page">
            <main class="cc-main">

                <!-- LEFT: board + players -->
                <section class="cc-board-area">

                    <div class="cc-board-wrap">
                        <div class="cc-frame">

                            <!-- TOP BAR -->
                            <div class="cc-boardbar cc-boardbar-top">
                                <div class="cc-player-left">
                                    <span class="cc-avatar" aria-hidden="true">
                                        <svg viewBox="0 0 64 64" role="img" focusable="false">
                                            <circle cx="32" cy="24" r="12"></circle>
                                            <path d="M12 56c2-12 12-20 20-20s18 8 20 20"></path>
                                        </svg>
                                    </span>
                                    <span>Opponent</span>
                                </div>

                                <span class="cc-timer" id="timerTop">10:00</span>
                            </div>

                            
                            <div id="board"></div>

                            <!-- BOTTOM BAR -->
                            <div class="cc-boardbar cc-boardbar-bottom">
                                <div class="cc-player-left">
                                    <span class="cc-avatar" aria-hidden="true">
                                        <svg viewBox="0 0 64 64" role="img" focusable="false">
                                            <circle cx="32" cy="24" r="12"></circle>
                                            <path d="M12 56c2-12 12-20 20-20s18 8 20 20"></path>
                                        </svg>
                                    </span>
                                    <span>Player</span>
                                </div>

                                <span class="cc-timer" id="timerBottom">10:00</span>
                            </div>

                        </div>
                    </div>

                    <div id="gameOverMessage" class="cc-gameover" style="display:none;"></div>

                </section>

                <!-- RIGHT: sidebar -->
                <aside class="cc-sidebar">

                    <div class="cc-card">
                        <button id="startBtn" class="cc-primary" type="button">Start Game</button>
                        <button id="surrenderBtn" class="cc-danger" type="button">Surrender</button>
                    <div class="cc-mode-select">
                        <button class="cc-mode-btn active" data-mode="player" type="button">Player</button>
                        <button class="cc-mode-btn" data-mode="cpu" type="button">CPU</button>

                    </div>

                <div class="cc-difficulty-select" style="display:none;">
                    <button class="cc-difficulty-btn active" data-level="beginner" type="button">Beginner</button>
                    <button class="cc-difficulty-btn" data-level="intermediate" type="button">Intermediate</button>
                    <button class="cc-difficulty-btn" data-level="expert" type="button">Expert</button>
                    <button class="cc-difficulty-btn" data-level="master" type="button">Master</button>
                </div>


                            <!-- Time selector -->
                        <div class="cc-time-select">
                            <button class="cc-time-btn active" data-time="10">10 min</button>
                            <button class="cc-time-btn" data-time="20">20 min</button>
                            <button class="cc-time-btn" data-time="30">30 min</button>
                        </div>
                    </div>

                    <div class="cc-card">
                        <div class="cc-section-title">Moves</div>
                        <ol id="moveList" class="cc-moves"></ol>
                    </div>

                </aside>

            </main>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="~/lib/chessboardjs/chessboard-1.0.0.js"></script>

<script>
    let selectedTime = 10;

    $('.cc-time-btn').click(function () {
        $('.cc-time-btn').removeClass('active');
        $(this).addClass('active');

        selectedTime = $(this).data('time');
        console.log("Selected time:", selectedTime);
    });
</script>

<script>
    let selectedMode = "player";
    let selectedDifficulty = "beginner";

    function updateDifficultyVisibility() {
        if (selectedMode === "cpu") {
            $('.cc-difficulty-select').fadeIn(120);
        } else {
            $('.cc-difficulty-select').fadeOut(120);
        }
    }

    $('.cc-mode-btn').click(function () {
        $('.cc-mode-btn').removeClass('active');
        $(this).addClass('active');

        selectedMode = $(this).data('mode');
        updateDifficultyVisibility();

        console.log("Selected mode:", selectedMode);
    });

    $('.cc-difficulty-btn').click(function () {
        $('.cc-difficulty-btn').removeClass('active');
        $(this).addClass('active');

        selectedDifficulty = $(this).data('level');
        console.log("Selected difficulty:", selectedDifficulty);
    });

    updateDifficultyVisibility();
</script>


<script>
    var lastFen = null;

    var board = Chessboard('board', {
        draggable: true,
        position: '@ViewBag.FEN',
        pieceTheme: '/lib/chessboardjs/img/chesspieces/wikipedia/{piece}.png',
        onDrop: onDrop
    });

    setTimeout(() => board.resize(), 0);
    setTimeout(() => board.resize(), 250);

    $(window).on('resize', function () {
        board.resize();
    });

    function onDrop(source, target, piece, newPos, oldPos, orientation) {
        $.ajax({
            url: '/Chess/Move',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ from: source, to: target }),

            success: function (response) {
                if (!response.valid) {
                    board.position(oldPos);
                    return;
                }

                board.position(response.fen);

                if (response.winner) {
                    $("#gameOverMessage")
                        .text("Checkmate! Winner: " + response.winner)
                        .fadeIn();
                }
            },

            error: function () {
                board.position(oldPos);
            }
        });
    }

    $('#startBtn').click(function () {
        $.post('/Chess/Reset', function (response) {
            board.position(response.fen);
            $("#gameOverMessage").hide().text("");
        });
    });

    $('#surrenderBtn').click(function () {
    $.post('/Chess/Surrender', function (response) {
        $("#gameOverMessage").text("You surrendered.").fadeIn();
    });
});

    setInterval(() => {
        $.get('/Chess/State', function (response) {
            if (response && response.fen && response.fen !== lastFen) {
                lastFen = response.fen;
                board.position(response.fen);
            }
        });
    }, 1000);
</script>
