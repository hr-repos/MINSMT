@{
    ViewData["Title"] = "Chess Game";
}

<link rel="stylesheet" href="~/lib/chessboardjs/chessboard-1.0.0.css" />
<link rel="stylesheet" href="~/css/site.css" />

<div class="cc-shell">

    <!-- LEFT: empty sidebar  -->
    <aside class="cc-leftbar">
    <div class="cc-leftbar-title">MINSMT</div>
    </aside>

    <!-- RIGHT: content -->
    <div class="cc-content">
        <div class="cc-page">
            <main class="cc-main">

                <!-- LEFT: board + players -->
                <section class="cc-board-area">

                    <div class="cc-board-wrap">
                        <div class="cc-frame">

                            <!-- TOP BAR -->
                            <div class="cc-boardbar cc-boardbar-top">
                                <div class="cc-player-left">
                                    <span class="cc-avatar" aria-hidden="true">
                                        <svg viewBox="0 0 64 64" role="img" focusable="false">
                                            <circle cx="32" cy="24" r="12"></circle>
                                            <path d="M12 56c2-12 12-20 20-20s18 8 20 20"></path>
                                        </svg>
                                    </span>
                                    <span>Opponent</span>
                                </div>

                                <span class="cc-timer" id="timerTop">10:00</span>
                            </div>

                            
                            <div id="board"></div>

                            <!-- BOTTOM BAR -->
                            <div class="cc-boardbar cc-boardbar-bottom">
                                <div class="cc-player-left">
                                    <span class="cc-avatar" aria-hidden="true">
                                        <svg viewBox="0 0 64 64" role="img" focusable="false">
                                            <circle cx="32" cy="24" r="12"></circle>
                                            <path d="M12 56c2-12 12-20 20-20s18 8 20 20"></path>
                                        </svg>
                                    </span>
                                    <span>Player</span>
                                </div>

                                <span class="cc-timer" id="timerBottom">10:00</span>
                            </div>

                        </div>
                            <div id="gameOverMessage" class="cc-gameover" style="display:none;"></div>
                            <div id="promotionPicker" class="cc-promo" style="display:none;"></div>
                    </div>

                </section>

                <!-- RIGHT: sidebar -->
                <aside class="cc-sidebar">

                    <div class="cc-card">
                        <button id="startBtn" class="cc-primary" type="button">Start Game</button>
                        <button id="resignBtn" class="cc-danger" type="button">Resign</button>
                    <div class="cc-mode-select">
                        <button class="cc-mode-btn active" data-mode="player" type="button">Player</button>
                        <button class="cc-mode-btn" data-mode="cpu" type="button">CPU</button>
                    </div>

                <div class="cc-difficulty-select" style="display:none;">
                    <button class="cc-difficulty-btn active" data-level="beginner" type="button">Beginner</button>
                    <button class="cc-difficulty-btn" data-level="intermediate" type="button">Intermediate</button>
                    <button class="cc-difficulty-btn" data-level="expert" type="button">Expert</button>
                    <button class="cc-difficulty-btn" data-level="master" type="button">Master</button>
                </div>
                <div class="cc-side-select" style="display:none;">
                        <button class="cc-side-btn active" data-side="white">White</button>
                        <button class="cc-side-btn" data-side="black">Black</button>
                    </div>


                            <!-- Time selector -->
                        <div class="cc-time-select">
                            <button class="cc-time-btn active" data-time="10">10 min</button>
                            <button class="cc-time-btn" data-time="20">20 min</button>
                            <button class="cc-time-btn" data-time="30">30 min</button>
                        </div>
                    </div>

                    <div class="cc-card">
                        <div class="cc-section-title">Moves</div>
                        <ol id="moveList" class="cc-moves"></ol>
                    </div>

                </aside>

            </main>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="~/lib/chessboardjs/chessboard-1.0.0.js"></script>

<script>
    let selectedTime = 10;
    let selectedMode = "player";
    let selectedDifficulty = "beginner";
    let selectedSide = "white";

    function updateDifficultyVisibility() {
        if (selectedMode === "cpu") {
            $('.cc-difficulty-select').fadeIn(120);
        } else {
            $('.cc-difficulty-select').fadeOut(120);
        }
    }

    function updateSideVisibility() {
        if (selectedMode === "cpu") {
            $('.cc-side-select').fadeIn(120);
        } else {
            $('.cc-side-select').fadeOut(120);
        }
    }

    $('.cc-time-btn').on('click', function () {
        if ($(this).hasClass('disabled')) return;

        $('.cc-time-btn').removeClass('active');
        $(this).addClass('active');

        selectedTime = $(this).data('time');
        console.log("Selected time:", selectedTime);
    });

    $('.cc-mode-btn').on('click', function () {
        if ($(this).hasClass('disabled')) return;

        $('.cc-mode-btn').removeClass('active');
        $(this).addClass('active');

        selectedMode = $(this).data('mode');
        updateDifficultyVisibility();
        updateSideVisibility();

        console.log("Selected mode:", selectedMode);
    });

    $('.cc-difficulty-btn').on('click', function () {
        if ($(this).hasClass('disabled')) return;

        $('.cc-difficulty-btn').removeClass('active');
        $(this).addClass('active');

        selectedDifficulty = $(this).data('level');
        console.log("Selected difficulty:", selectedDifficulty);
    });

    $('.cc-side-btn').on('click', function () {
        if ($(this).hasClass('disabled')) return;

        $('.cc-side-btn').removeClass('active');
        $(this).addClass('active');

        selectedSide = $(this).data('side');
        console.log("Selected side:", selectedSide);
    });

    updateDifficultyVisibility();
    updateSideVisibility();
</script>


<script>
    var board = null;
    var lastFen = null;
    var pendingPromotion = null;

    function lockGameSettings() {
        $('.cc-mode-btn, .cc-difficulty-btn, .cc-side-btn, .cc-time-btn').addClass('disabled');
    }

    function unlockGameSettings() {
        $('.cc-mode-btn, .cc-difficulty-btn, .cc-side-btn, .cc-time-btn').removeClass('disabled');
    }

    function clearCheckHighlight() {
        $('#board .cc-check').removeClass('cc-check');
        $('#board .cc-check-attacker').removeClass('cc-check-attacker');
    }

    function applyCheckHighlight(checkSquare, attackers) {
        clearCheckHighlight();

        if (checkSquare) {
            $('#board .square-' + checkSquare).addClass('cc-check');
        }

        if (attackers && attackers.length) {
            for (var i = 0; i < attackers.length; i++) {
                $('#board .square-' + attackers[i]).addClass('cc-check-attacker');
            }
        }
    }

    function createBoard(draggable, fen, orientation) {
        if (board) {
            board.destroy();
        }

        board = Chessboard('board', {
            draggable: draggable,
            position: fen,
            orientation: orientation,
            pieceTheme: '/lib/chessboardjs/img/chesspieces/wikipedia/{piece}.png',
            onDrop: onDrop
        });

        setTimeout(() => board.resize(), 0);
        setTimeout(() => board.resize(), 250);
    }

    function showGameOver(message, type, side) {
        $("#promotionPicker").hide();

        var msg = $("#gameOverMessage");

        msg
            .removeClass("win lose draw white black")
            .addClass(type);

        if (side) {
            msg.addClass(side);
        }

        msg.text(message).fadeIn();

        unlockGameSettings();

        var fen = (board && typeof board.fen === "function") ? board.fen() : lastFen;
        var ori = (board && typeof board.orientation === "function") ? board.orientation() : "white";
        createBoard(false, fen, ori);
    }

    $(window).on('resize', function () {
        if (board) board.resize();
    });

    function isPromotionMove(piece, target) {
        if (!piece || piece.length < 2) return false;

        var color = piece[0];
        var type = piece[1];
        if (type !== 'P') return false;

        var rank = target[1];
        return (color === 'w' && rank === '8') || (color === 'b' && rank === '1');
    }

    function showPromotionPicker(piece, targetSquare, onPick) {
        var picker = $("#promotionPicker");
        picker.empty();

        var color = piece[0];
        var choices = ["q", "n", "r", "b"];

        for (var i = 0; i < choices.length; i++) {
            (function (c) {
                var imgPiece = color + c.toUpperCase();
                var imgUrl = "/lib/chessboardjs/img/chesspieces/wikipedia/" + imgPiece + ".png";

                var btn = $('<button type="button"></button>');
                btn.append('<img src="' + imgUrl + '" alt="' + imgPiece + '">');
                btn.on("click", function () {
                    picker.hide();
                    onPick(c);
                });

                picker.append(btn);
            })(choices[i]);
        }

        var squareEl = $('#board .square-' + targetSquare);
        var wrap = $(".cc-board-wrap");

        if (squareEl.length === 0 || wrap.length === 0) {
            picker.hide();
            return;
        }

        var wrapOffset = wrap.offset();
        var sqOffset = squareEl.offset();
        var sqSize = squareEl.outerWidth();

        picker.css({ width: sqSize + "px", transform: "none" }).show();

        var wrapW = wrap.innerWidth();
        var wrapH = wrap.innerHeight();
        var pickerW = picker.outerWidth();
        var pickerH = picker.outerHeight();

        var left = (sqOffset.left - wrapOffset.left + sqSize + 6);
        var top = (sqOffset.top - wrapOffset.top);

        if (left + pickerW > wrapW - 6) {
            left = (sqOffset.left - wrapOffset.left - pickerW - 6);
        }
        if (left < 6) left = 6;

        if (top + pickerH > wrapH - 6) {
            top = top - pickerH + sqSize;
        }
        if (top < 6) top = 6;

        picker.css({
            left: left + "px",
            top: top + "px"
        });
    }

    function handleMoveResponse(response, oldPos) {
        if (!response || !response.valid) {
            if (oldPos) board.position(oldPos);
            return;
        }

        if (response.fen) {
            board.position(response.fen);
            lastFen = response.fen;
        }

        applyCheckHighlight(response.checkSquare, response.checkAttackers);

        if (response.winner) {
            if (response.winner === "Draw") {
                showGameOver("Draw", "draw");
            } else {
                var winnerSide = ("" + response.winner).toLowerCase();
                showGameOver("Checkmate! Winner: " + response.winner, "win", winnerSide);
            }
        }
    }

    function onDrop(source, target, piece, newPos, oldPos, orientation) {
        $("#promotionPicker").hide();

        if (isPromotionMove(piece, target)) {
            pendingPromotion = { from: source, to: target, oldPos: oldPos };

            showPromotionPicker(piece, target, function (promo) {
                if (!pendingPromotion) {
                    board.position(oldPos);
                    return;
                }

                $.ajax({
                    url: '/Chess/Move',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        from: pendingPromotion.from,
                        to: pendingPromotion.to,
                        promotion: promo
                    }),
                    success: function (response) {
                        handleMoveResponse(response, pendingPromotion.oldPos);
                        pendingPromotion = null;
                    },
                    error: function () {
                        board.position(pendingPromotion.oldPos);
                        pendingPromotion = null;
                    }
                });
            });

            return 'snapback';
        }

        $.ajax({
            url: '/Chess/Move',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ from: source, to: target }),
            success: function (response) {
                handleMoveResponse(response, oldPos);
            },
            error: function () {
                board.position(oldPos);
            }
        });
    }

    $('#startBtn').click(function () {
        $("#promotionPicker").hide();

        $.ajax({
            url: '/Chess/StartGame',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
            mode: selectedMode,
            side: selectedSide,
            difficulty: selectedDifficulty
            }),
            success: function (response) {
            if (!response) return;

            createBoard(true, response.fen, response.orientation);
            lastFen = response.fen;

            $("#gameOverMessage")
                .hide()
                .removeClass("win lose draw white black")
                .text("");

            clearCheckHighlight();

            lockGameSettings();

            applyCheckHighlight(response.checkSquare, response.checkAttackers);
            }
        });
    });


    $('#resignBtn').click(function () {
        $("#promotionPicker").hide();

        $.post('/Chess/Resign', function (response) {
            if (response && response.winner) {
                showGameOver("You resigned! Winner: " + response.winner, "lose");
            } else {
                showGameOver("You resigned!", "lose");
            }

            unlockGameSettings();
        });
    });

    setInterval(() => {
        if (!board) return;

        $.get('/Chess/State', function (response) {
            if (response && response.fen && response.fen !== lastFen) {
                lastFen = response.fen;
                board.position(response.fen);
                applyCheckHighlight(response.checkSquare, response.checkAttackers);
            } else if (response) {
                applyCheckHighlight(response.checkSquare, response.checkAttackers);
            }
        });
    }, 1000);

    createBoard(false, '@ViewBag.FEN', 'white');
</script>

